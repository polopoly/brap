<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.3 at May 31, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>BRAP (Forked) - Documentation</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20120531" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                BRAP
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
            
                <div class="xleft">
        <span id="publishDate">Last Published: 2012-05-31</span>
                  &nbsp;| <span id="projectVersion">Version: 1.0-SNAPSHOT</span>
                      </div>
            <div class="xright">        
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
            
                                <h5>Overview</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="misc.html" title="Miscellaneous">Miscellaneous</a>
            </li>
                  <li class="none">
            <strong>Documentation</strong>
          </li>
                  <li class="none">
                          <a href="getting-brap.html" title="Getting BRAP">Getting BRAP</a>
            </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="API Docs">API Docs</a>
            </li>
                  <li class="none">
                          <a href="faq.html" title="FAQ">FAQ</a>
            </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
            
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>Documentation<a name="Documentation"></a></h2><div class="section"><h3>Overview<a name="Overview"></a></h3><p>BRAP provides a simple and convenient way to expose your services via HTTP. BRAP is a Java only remoting protocol, as it uses standard Java object serialization techniques.</p><p>It is very simple to add authentication and custom authorization to BRAP-exposed services.</p><p>The client needs only the service interface method and the service endpoint URL to access the remote service. The remote service only needs a simple entry in web.xml to expose a class implementing the service interface as a remote service.</p><p>For more advanced server configuration scenarios, you can create the service wrapper programatically, or configure the service using Spring. Spring is an optional dependency on the server-side.</p></div><div class="section"><h3>Creating and exposing a remote service<a name="Creating_and_exposing_a_remote_service"></a></h3><p>In this tutorial we will create a simple service interface and implementation to guide you through a common remoting usecase. We start off with the basics and later add authentication and custom authorization.</p><div class="section"><h4>Creating the service interface<a name="Creating_the_service_interface"></a></h4><p>Since the client does not have the actual service class on it's classpath, you need to provide an interface to the client. This makes for a very simple and intuitive client usage. We define a simple interface called HelloService for this tutorial:</p><div class="source"><pre>public interface HelloService {
    public String sayHello(String name);
}</pre></div></div><div class="section"><h4>Creating the service implementation<a name="Creating_the_service_implementation"></a></h4><p>Let's implement the service interface as well:</p><div class="source"><pre>public class HelloServiceImpl implements HelloService {
    public String sayHello(String name) {
      return &quot;Hello there, &quot; + name;
    }
}</pre></div></div><div class="section"><h4>Exposing the service through web.xml<a name="Exposing_the_service_through_web.xml"></a></h4><p>We are now ready to expose our service in a servlet container. Make sure you have brap-server.jar and brap-common.jar in your WEB-INF/lib folder.</p><p>Your web.xml must contain a servlet definition and a servlet-mapping for the service:</p><div class="source"><pre>&lt;servlet&gt;
    &lt;servlet-name&gt;hello&lt;/servlet-name&gt;
    &lt;servlet-class&gt;no.tornado.brap.spring.ProxyServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;service&lt;/param-name&gt;
        &lt;param-value&gt;com.example.HelloServiceImpl&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;authorizationProvider&lt;/param-name&gt;
      &lt;param-value&gt;no.tornado.brap.auth.AuthenticationNotRequiredAuthorizer&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;

&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;hello&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/HelloService&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</pre></div><p>The authorizationProvider will allow unauthenticated access to the exposed service.</p><p>We map the service to the <i>/HelloService</i> pathname. This is all you need to expose a remote service!</p></div></div><div class="section"><h3>Accessing the service from your client<a name="Accessing_the_service_from_your_client"></a></h3><p>Using the service from the client involves getting a proxy for the interface and point it to the url of the exposed service:</p><div class="source"><pre>HttpClient client = new DefaultHttpClient();
HelloService helloService = ServiceProxyFactory.createProxy(HelloService.class, client,&quot;http://localhost:8080/HelloService&quot;);</pre></div><p>Note that you don't need to cast the result from createProxy(), due to generics. You can now use the class just as if it was a locally instantiated object:</p><div class="source"><pre>helloService.sayHello(&quot;John Doe&quot;);</pre></div></div><div class="section"><h3>Authentication<a name="Authentication"></a></h3><p>To provide authentication, BRAP uses the notion of an <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/auth/AuthenticationProvider.html">AuthenticationProvider</a> and an <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/auth/AuthorizationProvider.html">AuthorizationProvider</a>.</p><p>When you expose a remoting service, the actual service class is wrapped in a <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/servlet/ServiceWrapper.html">ServiceWrapper</a>.</p><p>In addition to holding an instance of the actual service, the <i>ServiceWrapper</i> is also configured with the two mentioned auth-providers.</p><p>The <i>AuthenticationProvider</i> is handed the <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/common/InvocationRequest.html">InvocationRequest</a> which contains the credentials from the client and tries to match it to an authenticated principal. If authentication is successful, the credentials are set in the <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/auth/AuthenticationContext.html">AuthenticationContext</a> and can be retrieved using <i>AuthenticationContext.getPrincipal()</i>.</p><p>The <i>AuthenticationProvider</i> must throw an <i>AuthenticationFailedException</i> unless the supplied credentials are sufficient.</p><p>The <i>AuthorizationProvider</i> then decides if the principal is allowed to invoke the requested method, and may throw a <i>AuthorizationFailedException</i>.</p><p>BRAP comes with a number of preconfigured Auth-schemes, making it extremely easy to protect your services with authentication, and implement finegrained or even role-based authorization. It is also very easy to write and install your own providers.</p><p>If you have created your own providers, you can set them directly in web.xml using the <i>authenticationProvider</i> and <i>authorizationProvider</i> init-parameters:</p><div class="source"><pre>&lt;init-param&gt;
    &lt;param-name&gt;authenticationProvider&lt;/param-name&gt;
    &lt;param-value&gt;com.example.MyAuthenticationProvider&lt;/param-value&gt;
&lt;/init-param&gt;
&lt;init-param&gt;
    &lt;param-name&gt;authorizationProvider&lt;/param-name&gt;
    &lt;param-value&gt;com.example.MyAuthorizationProvider&lt;/param-value&gt;
&lt;/init-param&gt;</pre></div><p>The default <i>AuthenticationProvider</i> is <i>AuthenticationNotRequiredAuthorizer</i>, and does nothing.</p><p>The default <i>AuthorizationProvider</i> is <i>AuthenticationRequiredAuthorizer</i> and requires any authenticated principal in the <i>AuthenticationContext</i>.</p><p>You must therefore either set the <i>AuthenticationNotRequiredAuthorizer</i> if you don't want auth, or set an <i>AuthenticationProvider</i> that actually authenticates the incoming credentials.</p><div class="section"><h4>Adding credentials when accessing the remote service<a name="Adding_credentials_when_accessing_the_remote_service"></a></h4><p>To authenticate with credentials, you supply a third argument to the <i>ServiceProxyFactory#createProxy</i> method discussed earlier. The third option is called &quot;credentials&quot;, and can be an arbitrary object as long as it is serializable.</p><p>We recommend that you use an existing domain object, for example a User as credentials if it makes sense to you.</p><div class="source"><pre>User user = new User(&quot;john&quot;, &quot;secret&quot;);

HttpClient client = new DefaultHttpClient();
HelloService helloService = (HelloService) ServiceProxyFactory.
        createProxy(HelloService.class, client, &quot;http://localhost:8080/HelloService&quot;, user);</pre></div><p>The user will now be available to the <i>AuthenticationProvider</i> in the <i>InvocationRequest#credentials</i> property. BRAP comes with a <i>UsernamePasswordPrincipal</i> which takes a username/password you can use at your convenience.</p><p>Both the <i>DatabaseUsernamePasswordAuthenticator</i> and the <i>SingleUsernamePasswordAuthenticator</i> expects the <i>UsernamePasswordPrincipal</i>.</p><p>You can later on change both the serviceURI and the credentials to an already created proxy:</p><div class="source"><pre>ServiceProxyFactory.setServiceURI(helloService, &quot;http://new-endpoint.example.com/HelloService&quot;);
ServiceProxyFactory.setCredentials(helloService, new User(&quot;other&quot;, &quot;credentials&quot;));</pre></div><p>It is also possible to create your own version of the <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/client/MethodInvocationHandler.html">MethodInvocationHandler</a> and override the <i>getCredentials</i> and <i>getServiceURI</i> methods so that you can supply fresh credentials/url's on every request.</p><p>Let's revisit the HelloServiceImpl we created earlier, adding a more interesting message:</p><div class="source"><pre>public class HelloServiceImpl implements HelloService {
    public String sayHello(String name) {
      if (AuthenticationContext.getPrincipal() instanceof UsernamePasswordPrincipal) {
        UsernamePasswordPrincipal upp = (UsernamePasswordPrincipal) AuthenticationContext.getPrincipal();
        return &quot;Hello &quot; + name + &quot;, you are authenticated as &quot; + upp.getUsername();
      } else {
        return &quot;Hello there, &quot; + name + &quot;, you are authenticated with a &quot; + AuthenticationContext.getPrincipal() +
        &quot;, which I don't know anything about.&quot;;
      }
    }
}</pre></div></div><div class="section"><h4>Instantiating auth-providers programatically<a name="Instantiating_auth-providers_programatically"></a></h4><p>Some authenticators cannot be created just by init-parameters in web.xml and needs to be constructed programatically. In these cases you have two choices:</p><ol style="list-style-type: decimal"><li>Subclass the provider and reference it in web.xml as usual</li><li>Subclass the <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/servlet/ProxyServlet.html">ProxyServlet</a> referred in web.xml and override <i>getServiceWrapper</i> or just one of <i>getAuthenticationProvider</i> or <i>getAuthorizationProvider</i>. Please see the javadoc for full details.</li></ol></div><div class="section"><h4>Instantiating the remoting service using Spring<a name="Instantiating_the_remoting_service_using_Spring"></a></h4><p>Chances are you are already using Spring on the server. You should then embrace Spring also for BRAP configuration and create the <i>ServiceWrapper</i> directly in your applicationContext.xml:</p><div class="source"><pre>&lt;bean id=&quot;helloRemoteService&quot; class=&quot;no.tornado.brap.servlet.ServiceWrapper&quot;&gt;
    &lt;property name=&quot;service&quot; ref=&quot;helloService&quot;/&gt;
    &lt;property name=&quot;authenticationProvider&quot; ref=&quot;authenticationProvider&quot;/&gt;
    &lt;property name=&quot;authorizationProvider&quot; ref=&quot;authorizationProvider&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;helloService&quot; class=&quot;no.tornado.brap.examples.service.HelloServiceImpl&quot;/&gt;

&lt;bean id=&quot;authenticationProvider&quot; class=&quot;no.tornado.brap.auth.SingleUsernamePasswordAuthenticator&quot;&gt;
    &lt;property name=&quot;username&quot; value=&quot;john&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;secret&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;authorizationProvider&quot; class=&quot;no.tornado.brap.auth.AuthenticationRequiredAuthorizer&quot;/&gt;</pre></div><p>Here we create the servicewrapper, refer to the service bean, and initialize the <i>SingleUsernamePasswordAuthenticator</i> with a pre-configured username/password combo.</p><p>The <i>AuthenticationRequiredAuthorizer</i> is used to only accept requests that supplied the correct username/password combination, tried by the <i>SingleUsernamePasswordAuthenticator</i>.</p><p>Your web.xml will now use the SpringProxyServlet class and only reference the spring-bean:</p><div class="source"><pre>&lt;servlet&gt;
    &lt;servlet-name&gt;hello&lt;/servlet-name&gt;
    &lt;servlet-class&gt;no.tornado.brap.spring.SpringProxyServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;beanName&lt;/param-name&gt;
        &lt;param-value&gt;helloRemoteService&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;</pre></div><p>Make sure you add <i>brap-spring.jar</i> to your classpath or include <i>brap-spring</i> in your <i>pom.xml</i> if you use Maven.</p></div><div class="section"><h4>Authenticating using a database<a name="Authenticating_using_a_database"></a></h4><p>If you have a database with your users, you can initialize the <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/auth/DatabaseUsernamePasswordAuthenticator.html">DatabaseUsernamePasswordAuthenticator</a> either with Spring or programatically as mentioned above.</p><p>You can subclass the authenticator to provide a different query string. Remember to pass in your datasource in the constructor or using setter injection.</p></div><div class="section"><h4>Authenticate using a custom DAO method<a name="Authenticate_using_a_custom_DAO_method"></a></h4><p>If is equally easy to implement the <i>AuthenticationProvider</i> interface and delegate to either a dao or service for authentication. Just subclass and set the needed resources on your authenticator.</p></div><div class="section"><h4>Protect methods depending on the supplied credentials<a name="Protect_methods_depending_on_the_supplied_credentials"></a></h4><p>The <i>AuthorizationProvider</i> recieves the actual <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/common/InvocationRequest.html">InvocationRequest</a> so that it can lookup the actual method being invoked, intercept/modify the method arguments, and check the principal in the AuthenticationContext before authorizing the method invocation.</p><p>The AuthorizationProvider will throw an <a class="externalLink" href="http://polopoly.github.com/brap/apidocs/no/tornado/brap/exception/AuthorizationFailedException.html">AuthorizationFailedException</a> to signal that the supplied credentials were insufficient to invoke the requested method.</p></div></div><div class="section"><h3>Pass by reference<a name="Pass_by_reference"></a></h3><p>When you send an object as an argument from the client, the remote service might change some properties on that object. Let's say for example that you call myservice.saveUser(user) with your domain object user. The service might set the user.id field after save, but this property will not be visible on the client after the call.</p><p>BRAP has an addon-module that will automatically sync changes on your object arguments that happen on the server side, so that you can enjoy &quot;pass by reference&quot;-like behaviour even when the objects are serialized and detached.</p><p>To use this feature, add the <i>brap-modification</i> jar to your project and configure the <i>modificationManager</i>.</p><p>For web.xml remoting configuration, you add another param:</p><div class="source"><pre>    &lt;init-param&gt;
        &lt;param-name&gt;modificationManager&lt;/param-name&gt;
        &lt;param-value&gt;no.tornado.brap.modification.SetterModificationManager&lt;/param-value&gt;
    &lt;/init-param&gt;</pre></div><p>For Spring configuration in applicationContext.xml:</p><div class="source"><pre>    &lt;bean id=&quot;helloService&quot; class=&quot;no.tornado.brap.servlet.ServiceWrapper&quot;&gt;
        [...]
        &lt;property name=&quot;modificationManager&quot; ref=&quot;modificationManager&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;modificationManager&quot; class=&quot;no.tornado.brap.modification.SetterModificationManager&quot;&gt;
        &lt;property name=&quot;depth&quot; value=&quot;25&quot;/&gt;
        &lt;property name=&quot;proxyClassDefinitions&quot;&gt;
            &lt;list&gt;
                &lt;value&gt;com.example.domain.*&lt;/value&gt;
            &lt;/list&gt;
        &lt;/property&gt;
    &lt;/bean&gt;</pre></div><p>The Spring example above also sets the depth of the object graph to look for changes, and what classes of properties should be watched for changes under the subsequent depth levels.</p><p>If you don't use Spring and want to modify <i>depth</i> and <i>proxyClassDefinitions</i> you can subclass the SetterModificationManager and override the <i>depth</i> and <i>proxyClassDefinition</i> getters.</p></div><div class="section"><h3>Remoting with Streams<a name="Remoting_with_Streams"></a></h3><p>There is a separate page that describes <a class="externalLink" href="http://polopoly.github.com/brap/remoting-with-streams.html">remoting with streams</a> and some gotchas.</p></div><div class="section"><h3>More information<a name="More_information"></a></h3><p>Please check out the <i>brap-examples</i> project for more information and code samples.</p></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2012
                        <a href="http://www.atex.com/">Atex</a>.
            All Rights Reserved.      
            
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
